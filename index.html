<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Learning Tools ‚Äî Risorse Educative STEAM</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f5f3ef;
      --surface: #ffffff;
      --surface-alt: #f0ede7;
      --border: #e0dbd2;
      --accent: #5c6e4e;
      --accent-light: #a3b58a;
      --accent-muted: #d6e3c8;
      --text-primary: #2a2820;
      --text-secondary: #6b6556;
      --text-muted: #9e9788;
      --link: #3d5a8a;
      --link-hover: #2c4168;
      --tag-bg: #edeae3;
      --shadow: 0 2px 12px rgba(60,55,45,0.07);
      --shadow-card: 0 4px 20px rgba(60,55,45,0.10);
      --danger: #c0392b;
      --success: #27ae60;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      line-height: 1.65;
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ‚îÄ ADMIN BAR (hidden by default) ‚îÄ‚îÄ‚îÄ */
    #admin-bar {
      background: #2a2820;
      color: #c8c4bb;
      padding: 0.55rem 1.5rem;
      display: none;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.76rem;
    }
    #admin-bar.visible { display: flex; }
    #admin-bar label { font-weight: 500; white-space: nowrap; color: #a8a49b; }
    #admin-bar input {
      padding: 0.28rem 0.6rem;
      border: 1px solid #4a4840;
      border-radius: 5px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.76rem;
      background: #3a3830;
      color: #e8e4db;
      outline: none;
      transition: border-color 0.2s;
    }
    #admin-bar input:focus { border-color: var(--accent-light); }
    #admin-bar input[type="password"] { letter-spacing: 0.1em; }
    #admin-input-owner { width: 120px; }
    #admin-input-repo  { width: 150px; }
    #admin-input-token { width: 210px; }
    #admin-btn-connect {
      background: var(--accent); color: white; border: none;
      border-radius: 5px; padding: 0.3rem 0.8rem;
      font-family: 'DM Sans', sans-serif; font-size: 0.76rem; font-weight: 600;
      cursor: pointer; transition: background 0.15s;
    }
    #admin-btn-connect:hover { background: #4a5a3e; }
    #admin-btn-connect:disabled { opacity: 0.5; cursor: not-allowed; }
    #admin-status {
      font-weight: 600; font-size: 0.72rem;
      padding: 0.18rem 0.6rem; border-radius: 20px;
    }
    #admin-status.ok   { background: #1a3a28; color: #5dbe80; }
    #admin-status.err  { background: #3a1a1a; color: #e07070; }
    #admin-status.idle { background: #3a3830; color: #888; }
    #admin-bar-close {
      margin-left: auto; background: none; border: none;
      color: #666; cursor: pointer; font-size: 1rem; padding: 0 0.2rem;
      transition: color 0.15s;
    }
    #admin-bar-close:hover { color: #ccc; }

    /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 2.5rem 2rem 2rem;
      text-align: center;
      position: sticky; top: 0; z-index: 100;
      box-shadow: var(--shadow);
    }
    header .logo { display: inline-flex; align-items: center; gap: 0.6rem; margin-bottom: 0.35rem; }
    header .logo-icon {
      width: 36px; height: 36px; background: var(--accent); border-radius: 8px;
      display: flex; align-items: center; justify-content: center; color: white; font-size: 1.1rem;
    }
    header h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.5rem, 3.5vw, 2.2rem);
      font-weight: 700; color: var(--text-primary); letter-spacing: -0.02em;
    }
    header p.subtitle { color: var(--text-secondary); font-size: 0.92rem; font-weight: 300; margin-top: 0.2rem; }
    .search-wrap { max-width: 520px; margin: 1.2rem auto 0; }
    .search-wrap input {
      width: 100%; padding: 0.65rem 1rem 0.65rem 2.8rem;
      border: 1.5px solid var(--border); border-radius: 40px;
      background: var(--bg);
      font-family: 'DM Sans', sans-serif; font-size: 0.9rem; color: var(--text-primary);
      outline: none; transition: border-color 0.2s, box-shadow 0.2s;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239e9788' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: 0.9rem center;
    }
    .search-wrap input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-muted); }

    /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
    .container { max-width: 1320px; margin: 0 auto; padding: 2rem 1.5rem 4rem; }

    /* ‚îÄ‚îÄ‚îÄ STATS BAR ‚îÄ‚îÄ‚îÄ */
    .stats { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 2.2rem; align-items: center; }
    .stat-chip {
      background: var(--surface); border: 1px solid var(--border); border-radius: 20px;
      padding: 0.3rem 0.85rem; font-size: 0.78rem; color: var(--text-secondary); font-weight: 500;
    }
    .stat-chip span { color: var(--accent); font-weight: 600; }

    /* add resource button ‚Äî hidden until admin login */
    #btn-add-resource {
      display: none; margin-left: auto;
      background: var(--accent); color: white; border: none; border-radius: 20px;
      padding: 0.35rem 1rem;
      font-family: 'DM Sans', sans-serif; font-size: 0.78rem; font-weight: 600;
      cursor: pointer; align-items: center; gap: 0.4rem;
      transition: background 0.18s, transform 0.15s;
    }
    #btn-add-resource.visible { display: flex; }
    #btn-add-resource:hover { background: #4a5a3e; transform: translateY(-1px); }

    /* ‚îÄ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ‚îÄ */
    #loading-state { text-align: center; padding: 5rem 1rem; color: var(--text-muted); }
    #loading-state .spinner-lg {
      width: 36px; height: 36px;
      border: 3px solid var(--border); border-top-color: var(--accent);
      border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem;
    }

    /* ‚îÄ‚îÄ‚îÄ FILTER PILLS ‚îÄ‚îÄ‚îÄ */
    .filter-bar { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 2rem; }
    .filter-pill {
      background: var(--surface); border: 1.5px solid var(--border); border-radius: 20px;
      padding: 0.28rem 0.8rem; font-size: 0.76rem; font-weight: 500;
      color: var(--text-secondary); cursor: pointer; transition: all 0.18s; user-select: none;
    }
    .filter-pill:hover, .filter-pill.active { background: var(--accent); border-color: var(--accent); color: white; }

    /* ‚îÄ‚îÄ‚îÄ GRID & CARDS ‚îÄ‚îÄ‚îÄ */
    .categories-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.4rem; }
    .cat-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
      overflow: hidden; box-shadow: var(--shadow); transition: box-shadow 0.2s, transform 0.2s;
      animation: fadeUp 0.4s ease both;
    }
    .cat-card:hover { box-shadow: var(--shadow-card); transform: translateY(-2px); }
    .cat-header {
      display: flex; align-items: center; gap: 0.7rem;
      padding: 1rem 1.2rem 0.9rem; background: var(--surface-alt); border-bottom: 1px solid var(--border);
    }
    .cat-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
    .cat-title { font-family: 'Playfair Display', serif; font-size: 0.97rem; font-weight: 700; color: var(--text-primary); letter-spacing: 0.01em; }
    .cat-count { margin-left: auto; background: var(--tag-bg); color: var(--text-muted); border-radius: 10px; padding: 0.1rem 0.55rem; font-size: 0.72rem; font-weight: 600; flex-shrink: 0; }
    .cat-body { padding: 0.9rem 1.2rem 1rem; }
    .sub-section { margin-bottom: 0.85rem; }
    .sub-label { font-size: 0.7rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--accent); margin-bottom: 0.4rem; padding-bottom: 0.25rem; border-bottom: 1px dashed var(--accent-muted); }
    .link-list { list-style: none; }
    .link-item { display: flex; flex-direction: column; padding: 0.4rem 0; border-bottom: 1px solid #f2efe9; }
    .link-item:last-child { border-bottom: none; }
    .link-note { font-size: 0.7rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.1rem; text-transform: capitalize; }
    .link-item a { font-size: 0.82rem; color: var(--link); text-decoration: none; word-break: break-word; transition: color 0.15s; display: flex; align-items: center; gap: 0.3rem; }
    .link-item a::before { content: '‚Üó'; font-size: 0.65rem; color: var(--accent-light); flex-shrink: 0; }
    .link-item a:hover { color: var(--link-hover); text-decoration: underline; }

    .no-results { text-align: center; padding: 4rem 1rem; color: var(--text-muted); display: none; }
    .no-results h3 { font-size: 1.1rem; margin-bottom: 0.4rem; }

    /* ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ */
    footer {
      text-align: center; padding: 1.5rem 2rem; font-size: 0.76rem; color: var(--text-muted);
      border-top: 1px solid var(--border); background: var(--surface);
      display: flex; justify-content: center; align-items: center; gap: 1.2rem;
    }
    #footer-admin-link {
      color: var(--border); cursor: pointer; font-size: 0.8rem;
      transition: color 0.2s; user-select: none; text-decoration: none;
      border: none; background: none; font-family: inherit;
    }
    #footer-admin-link:hover { color: var(--text-muted); }

    /* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(42,40,32,0.45); backdrop-filter: blur(3px);
      z-index: 500; display: flex; align-items: center; justify-content: center; padding: 1rem;
      opacity: 0; pointer-events: none; transition: opacity 0.22s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }
    .modal {
      background: var(--surface); border-radius: 16px; width: 100%; max-width: 520px;
      box-shadow: 0 20px 60px rgba(42,40,32,0.18);
      transform: translateY(20px); transition: transform 0.22s; overflow: hidden;
    }
    .modal-overlay.open .modal { transform: translateY(0); }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 1.2rem 1.4rem 1rem; border-bottom: 1px solid var(--border); background: var(--surface-alt);
    }
    .modal-header h2 { font-family: 'Playfair Display', serif; font-size: 1.05rem; font-weight: 700; }
    .modal-close {
      background: none; border: none; cursor: pointer; color: var(--text-muted);
      font-size: 1.3rem; line-height: 1; padding: 0.1rem 0.3rem; border-radius: 4px; transition: color 0.15s, background 0.15s;
    }
    .modal-close:hover { color: var(--text-primary); background: var(--tag-bg); }
    .modal-body { padding: 1.4rem; }
    .form-row { margin-bottom: 1.1rem; }
    .form-row label { display: block; font-size: 0.76rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.35rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .form-row input, .form-row select {
      width: 100%; padding: 0.55rem 0.8rem; border: 1.5px solid var(--border); border-radius: 8px;
      font-family: 'DM Sans', sans-serif; font-size: 0.88rem; color: var(--text-primary);
      background: var(--bg); outline: none; transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-row input:focus, .form-row select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-muted); }
    .form-row .hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.3rem; }
    #new-cat-fields {
      background: var(--surface-alt); border: 1px dashed var(--border); border-radius: 8px;
      padding: 0.9rem; margin-top: 0.6rem; display: none;
    }
    #new-cat-fields.visible { display: block; }
    #new-cat-fields .form-row { margin-bottom: 0.7rem; }
    #new-cat-fields .form-row:last-child { margin-bottom: 0; }
    .modal-footer { display: flex; gap: 0.7rem; justify-content: flex-end; padding: 1rem 1.4rem 1.4rem; border-top: 1px solid var(--border); }
    .btn { padding: 0.5rem 1.2rem; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-secondary { background: var(--tag-bg); color: var(--text-secondary); }
    .btn-secondary:hover { background: var(--border); }
    .btn-primary { background: var(--accent); color: white; min-width: 140px; display: flex; align-items: center; justify-content: center; gap: 0.4rem; }
    .btn-primary:hover { background: #4a5a3e; }
    .btn-primary:disabled { opacity: 0.55; cursor: not-allowed; }

    /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
    #toast {
      position: fixed; bottom: 2rem; left: 50%;
      transform: translateX(-50%) translateY(30px);
      background: var(--text-primary); color: white;
      padding: 0.7rem 1.4rem; border-radius: 30px; font-size: 0.84rem; font-weight: 500;
      z-index: 1000; opacity: 0; transition: opacity 0.25s, transform 0.25s;
      pointer-events: none; white-space: nowrap;
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    #toast.success { background: var(--success); }
    #toast.error   { background: var(--danger); }

    .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.4); border-top-color: white; border-radius: 50%; animation: spin 0.7s linear infinite; flex-shrink: 0; }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 640px) {
      header { padding: 1.5rem 1rem 1rem; position: relative; }
      .container { padding: 1.2rem 1rem 3rem; }
      .categories-grid { grid-template-columns: 1fr; gap: 1rem; }
      #admin-bar { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ ADMIN BAR ‚Äî hidden, opened via footer icon ‚îÄ‚îÄ‚îÄ -->
<div id="admin-bar">
  <label>Admin:</label>
  <input id="admin-input-owner" type="text"     placeholder="username" title="GitHub username" />
  <span style="color:#555">/</span>
  <input id="admin-input-repo"  type="text"     placeholder="repository" title="Nome repository" />
  <input id="admin-input-token" type="password" placeholder="Personal Access Token (ghp_‚Ä¶)" />
  <button id="admin-btn-connect">Connetti</button>
  <span id="admin-status" class="idle">‚¨§ non connesso</span>
  <button id="admin-bar-close" title="Chiudi">‚úï</button>
</div>

<!-- ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ -->
<header>
  <div class="logo">
    <div class="logo-icon">üìö</div>
    <h1>Learning Tools</h1>
  </div>
  <p class="subtitle">Raccolta di risorse educative STEAM</p>
  <div class="search-wrap">
    <input type="text" id="search" placeholder="Cerca una risorsa o categoria‚Ä¶" />
  </div>
</header>

<div class="container">
  <div class="stats" id="stats">
    <div class="stat-chip">Categorie: <span id="cat-count">‚Äî</span></div>
    <div class="stat-chip">Link totali: <span id="link-count">‚Äî</span></div>
    <button id="btn-add-resource">Ôºã Aggiungi risorsa</button>
  </div>

  <div id="loading-state">
    <div class="spinner-lg"></div>
    <p>Caricamento risorse‚Ä¶</p>
  </div>

  <div class="filter-bar" id="filter-bar" style="display:none"></div>
  <div class="categories-grid" id="grid"></div>
  <div class="no-results" id="no-results">
    <h3>Nessun risultato</h3>
    <p>Prova un termine di ricerca diverso.</p>
  </div>
</div>

<footer>
  <span> by:  <a href="https://www.adrianoparracciani.it/" target="_blank" > Adriano Parracciani</a></span>
  <button id="footer-admin-link" title="Pannello amministratore">‚öô</button>
</footer>

<!-- ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-header">
      <h2 id="modal-title">‚ûï Aggiungi risorsa</h2>
      <button class="modal-close" id="modal-close">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <label for="f-category">Categoria *</label>
        <select id="f-category">
          <option value="">‚Äî seleziona categoria ‚Äî</option>
          <option value="__new__">‚ú¶ Crea nuova categoria‚Ä¶</option>
        </select>
      </div>
      <div id="new-cat-fields">
        <div class="form-row">
          <label for="f-new-title">Nome categoria *</label>
          <input id="f-new-title" type="text" placeholder="es. Design Tools" />
        </div>
        <div class="form-row">
          <label for="f-new-icon">Icona emoji *</label>
          <input id="f-new-icon" type="text" placeholder="es. üé®" maxlength="4" style="width:80px" />
        </div>
        <div class="form-row" style="margin-bottom:0">
          <label for="f-new-color">Colore sfondo card</label>
          <input id="f-new-color" type="color" value="#eef2fb" style="width:60px;height:34px;padding:2px;cursor:pointer" />
        </div>
      </div>
      <div class="form-row" id="row-subsection" style="display:none">
        <label for="f-subsection">Sottocategoria <span style="font-weight:400;text-transform:none">(opzionale)</span></label>
        <select id="f-subsection"><option value="">‚Äî nessuna ‚Äî</option></select>
      </div>
      <div class="form-row">
        <label for="f-note">Descrizione / nome risorsa *</label>
        <input id="f-note" type="text" placeholder="es. Teachable Machine ‚Äì Google" />
      </div>
      <div class="form-row">
        <label for="f-url">URL *</label>
        <input id="f-url" type="url" placeholder="https://‚Ä¶" />
        <p class="hint" id="url-hint"></p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="modal-cancel">Annulla</button>
      <button class="btn btn-primary"   id="modal-save"><span id="save-label">Salva su GitHub</span></button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ‚öôÔ∏è  CONFIGURA QUESTI DUE VALORI prima di pubblicare
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GH_OWNER     = 'cyberparra';    // es. 'mariorossi'
const GH_REPO      = 'cyberparra/Learning-ToolsSITORY'; // es. 'learning-tools'
const GH_FILE_PATH = 'data.json';
const GH_BRANCH    = 'main';

// URL pubblica raw ‚Äî nessun token necessario per la lettura
const RAW_URL = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}/${GH_FILE_PATH}`;

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let DATA    = [];
let ghToken = '';
let fileSha = '';
let isAdmin = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LETTURA PUBBLICA ‚Äî caricamento automatico all'avvio
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async () => {
  try {
    const res = await fetch(RAW_URL + '?t=' + Date.now());
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    DATA = await res.json();
    initUI();
  } catch (e) {
    document.getElementById('loading-state').innerHTML =
      `<p style="color:var(--danger)">‚ùå Impossibile caricare i dati.</p>
       <p style="margin-top:0.5rem;font-size:0.82rem;color:var(--text-muted)">
         Verifica che <code>${GH_OWNER}/${GH_REPO}</code> sia corretto e il repo sia pubblico.<br>
         Errore: ${e.message}
       </p>`;
  }
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GITHUB API (solo admin autenticato)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function ghFetch(path, opts = {}) {
  const res = await fetch(`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/${path}`, {
    ...opts,
    headers: {
      'Authorization': `Bearer ${ghToken}`,
      'Accept': 'application/vnd.github+json',
      'X-GitHub-Api-Version': '2022-11-28',
      ...(opts.headers || {})
    }
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.message || `HTTP ${res.status}`);
  }
  return res.json();
}

async function loadFileSha() {
  const file = await ghFetch(`contents/${GH_FILE_PATH}?ref=${GH_BRANCH}`);
  fileSha = file.sha;
}

async function saveDataToGitHub(newData, msg) {
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(newData, null, 2))));
  const res = await ghFetch(`contents/${GH_FILE_PATH}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: msg, content, sha: fileSha, branch: GH_BRANCH })
  });
  fileSha = res.content.sha;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('footer-admin-link').addEventListener('click', () => {
  document.getElementById('admin-bar').classList.toggle('visible');
});
document.getElementById('admin-bar-close').addEventListener('click', () => {
  document.getElementById('admin-bar').classList.remove('visible');
});

document.getElementById('admin-btn-connect').addEventListener('click', async () => {
  const token = document.getElementById('admin-input-token').value.trim();
  if (!token) { toast('Inserisci il Personal Access Token', 'error'); return; }

  // owner/repo nei campi possono sovrascrivere quelli hardcoded
  const inputOwner = document.getElementById('admin-input-owner').value.trim();
  const inputRepo  = document.getElementById('admin-input-repo').value.trim();
  if (inputOwner) window._ghOwnerOverride = inputOwner;
  if (inputRepo)  window._ghRepoOverride  = inputRepo;

  ghToken = token;
  const btn = document.getElementById('admin-btn-connect');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner" style="width:12px;height:12px;border-width:2px;margin:0 auto"></div>';
  setAdminStatus('idle', '‚¨§ connessione‚Ä¶');

  try {
    await loadFileSha();
    isAdmin = true;
    setAdminStatus('ok', '‚úì admin connesso');
    document.getElementById('btn-add-resource').classList.add('visible');
    document.getElementById('admin-bar').classList.remove('visible');
    toast('‚úì Accesso admin attivo', 'success');
  } catch (e) {
    ghToken = ''; isAdmin = false;
    setAdminStatus('err', '‚úó ' + e.message);
    toast('Login fallito: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Connetti';
  }
});

function setAdminStatus(type, text) {
  const el = document.getElementById('admin-status');
  el.className = type;
  el.textContent = text;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function countLinks(cat) {
  if (cat.subsections) return cat.subsections.reduce((s, sub) => s + sub.links.length, 0);
  return cat.links ? cat.links.length : 0;
}

function buildLinkList(links, listEl) {
  links.forEach(l => {
    const li = document.createElement('li');
    li.className = 'link-item';
    if (l.note) {
      const n = document.createElement('span');
      n.className = 'link-note';
      n.textContent = l.note;
      li.appendChild(n);
    }
    const a = document.createElement('a');
    a.href = l.url; a.target = '_blank'; a.rel = 'noopener noreferrer';
    try {
      const p = new URL(l.url);
      a.textContent = p.hostname.replace(/^www\./, '') + (p.pathname.length > 1 ? p.pathname.slice(0, 40) : '');
    } catch { a.textContent = l.url.slice(0, 60); }
    li.appendChild(a);
    listEl.appendChild(li);
  });
}

function buildCard(cat) {
  const card = document.createElement('div');
  card.className = 'cat-card'; card.dataset.id = cat.id;
  const hdr = document.createElement('div'); hdr.className = 'cat-header';
  const icon = document.createElement('div'); icon.className = 'cat-icon'; icon.style.background = cat.color || '#eef2fb'; icon.textContent = cat.icon;
  const title = document.createElement('span'); title.className = 'cat-title'; title.textContent = cat.title;
  const count = document.createElement('span'); count.className = 'cat-count'; count.textContent = countLinks(cat);
  hdr.appendChild(icon); hdr.appendChild(title); hdr.appendChild(count); card.appendChild(hdr);
  const body = document.createElement('div'); body.className = 'cat-body';
  if (cat.subsections) {
    cat.subsections.forEach(sub => {
      const sec = document.createElement('div'); sec.className = 'sub-section';
      const lbl = document.createElement('div'); lbl.className = 'sub-label'; lbl.textContent = sub.label;
      const ul = document.createElement('ul'); ul.className = 'link-list';
      buildLinkList(sub.links, ul); sec.appendChild(lbl); sec.appendChild(ul); body.appendChild(sec);
    });
  } else {
    const ul = document.createElement('ul'); ul.className = 'link-list';
    buildLinkList(cat.links || [], ul); body.appendChild(ul);
  }
  card.appendChild(body); return card;
}

function renderAll(list) {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  document.getElementById('no-results').style.display = list.length === 0 ? 'block' : 'none';
  list.forEach((cat, i) => {
    const card = buildCard(cat);
    card.style.animationDelay = Math.min(i * 0.03, 0.3) + 's';
    grid.appendChild(card);
  });
}

let activeFilter = 'all';

function applyFilters() {
  const query = document.getElementById('search').value.toLowerCase().trim();
  let result = DATA;
  if (activeFilter !== 'all') result = result.filter(c => c.id === activeFilter);
  if (query) {
    result = result.map(cat => {
      if (cat.title.toLowerCase().includes(query)) return cat;
      if (cat.subsections) {
        const subs = cat.subsections.map(sub => ({
          ...sub, links: sub.links.filter(l => (l.note||'').toLowerCase().includes(query) || l.url.toLowerCase().includes(query))
        })).filter(s => s.links.length > 0);
        if (subs.length) return { ...cat, subsections: subs };
      }
      if (cat.links) {
        const fl = cat.links.filter(l => (l.note||'').toLowerCase().includes(query) || l.url.toLowerCase().includes(query));
        if (fl.length) return { ...cat, links: fl };
      }
      return null;
    }).filter(Boolean);
  }
  renderAll(result);
}

function initUI() {
  document.getElementById('loading-state').style.display = 'none';
  const total = DATA.reduce((s, c) => s + countLinks(c), 0);
  document.getElementById('cat-count').textContent  = DATA.length;
  document.getElementById('link-count').textContent = total;

  const filterBar = document.getElementById('filter-bar');
  filterBar.innerHTML = ''; filterBar.style.display = 'flex';
  const allPill = document.createElement('div');
  allPill.className = 'filter-pill active'; allPill.textContent = 'Tutte'; allPill.dataset.id = 'all';
  filterBar.appendChild(allPill);
  DATA.forEach(cat => {
    const pill = document.createElement('div');
    pill.className = 'filter-pill'; pill.textContent = cat.title; pill.dataset.id = cat.id;
    filterBar.appendChild(pill);
  });
  filterBar.addEventListener('click', e => {
    const pill = e.target.closest('.filter-pill'); if (!pill) return;
    activeFilter = pill.dataset.id;
    filterBar.querySelectorAll('.filter-pill').forEach(p => p.classList.toggle('active', p.dataset.id === activeFilter));
    applyFilters();
  });
  document.getElementById('search').addEventListener('input', applyFilters);
  renderAll(DATA);
  populateCategorySelect();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const overlay      = document.getElementById('modal-overlay');
const fCategory    = document.getElementById('f-category');
const fSubsection  = document.getElementById('f-subsection');
const rowSubsect   = document.getElementById('row-subsection');
const newCatFields = document.getElementById('new-cat-fields');
const fNote        = document.getElementById('f-note');
const fUrl         = document.getElementById('f-url');
const modalSave    = document.getElementById('modal-save');
const saveLabel    = document.getElementById('save-label');

document.getElementById('btn-add-resource').addEventListener('click', () => {
  if (!isAdmin) { toast('Accedi come admin per aggiungere risorse', 'error'); return; }
  overlay.classList.add('open'); fCategory.focus();
});
document.getElementById('modal-close').addEventListener('click', closeModal);
document.getElementById('modal-cancel').addEventListener('click', closeModal);
overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

function closeModal() { overlay.classList.remove('open'); resetForm(); }
function resetForm() {
  fCategory.value = ''; fSubsection.value = ''; fNote.value = ''; fUrl.value = '';
  document.getElementById('f-new-title').value = '';
  document.getElementById('f-new-icon').value  = '';
  document.getElementById('f-new-color').value = '#eef2fb';
  rowSubsect.style.display = 'none'; newCatFields.classList.remove('visible');
  document.getElementById('url-hint').textContent = '';
  saveLabel.textContent = 'Salva su GitHub'; modalSave.disabled = false;
}

function populateCategorySelect() {
  fCategory.innerHTML = '<option value="">‚Äî seleziona categoria ‚Äî</option>';
  DATA.forEach(cat => {
    const opt = document.createElement('option'); opt.value = cat.id; opt.textContent = `${cat.icon} ${cat.title}`;
    fCategory.appendChild(opt);
  });
  const newOpt = document.createElement('option'); newOpt.value = '__new__'; newOpt.textContent = '‚ú¶ Crea nuova categoria‚Ä¶';
  fCategory.appendChild(newOpt);
}

fCategory.addEventListener('change', () => {
  const val = fCategory.value;
  newCatFields.classList.toggle('visible', val === '__new__');
  fSubsection.innerHTML = '<option value="">‚Äî nessuna ‚Äî</option>';
  if (val && val !== '__new__') {
    const cat = DATA.find(c => c.id === val);
    if (cat?.subsections) {
      rowSubsect.style.display = 'block';
      cat.subsections.forEach(sub => {
        const opt = document.createElement('option'); opt.value = sub.label; opt.textContent = sub.label;
        fSubsection.appendChild(opt);
      });
    } else { rowSubsect.style.display = 'none'; }
  } else { rowSubsect.style.display = 'none'; }
});

fUrl.addEventListener('input', () => {
  const v = fUrl.value.trim(); const hint = document.getElementById('url-hint');
  if (!v) { hint.textContent = ''; return; }
  try { new URL(v); hint.textContent = '‚úì URL valido'; hint.style.color = 'var(--success)'; }
  catch { hint.textContent = '‚úó URL non valido'; hint.style.color = 'var(--danger)'; }
});

modalSave.addEventListener('click', async () => {
  const catId = fCategory.value;
  const note  = fNote.value.trim();
  const url   = fUrl.value.trim();
  if (!catId) { toast('Seleziona una categoria', 'error'); return; }
  if (!note)  { toast('Inserisci una descrizione', 'error'); return; }
  if (!url)   { toast('Inserisci un URL', 'error'); return; }
  try { new URL(url); } catch { toast('URL non valido', 'error'); return; }

  const newLink = { note, url };
  const newData = JSON.parse(JSON.stringify(DATA));

  if (catId === '__new__') {
    const newTitle = document.getElementById('f-new-title').value.trim();
    const newIcon  = document.getElementById('f-new-icon').value.trim();
    const newColor = document.getElementById('f-new-color').value;
    if (!newTitle || !newIcon) { toast('Inserisci nome e icona per la nuova categoria', 'error'); return; }
    const newId = newTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    if (newData.find(c => c.id === newId)) { toast('Categoria gi√† esistente', 'error'); return; }
    newData.push({ id: newId, title: newTitle, icon: newIcon, color: newColor, links: [newLink] });
    newData.sort((a, b) => a.title.localeCompare(b.title));
  } else {
    const cat = newData.find(c => c.id === catId);
    const subLabel = fSubsection.value;
    if (subLabel && cat.subsections) {
      const sub = cat.subsections.find(s => s.label === subLabel);
      if (sub) sub.links.push(newLink);
      else cat.subsections.push({ label: subLabel, links: [newLink] });
    } else {
      if (!cat.links) cat.links = [];
      cat.links.push(newLink);
    }
  }

  modalSave.disabled = true;
  saveLabel.innerHTML = '<div class="spinner"></div> Salvataggio‚Ä¶';

  try {
    const catName = catId === '__new__'
      ? document.getElementById('f-new-title').value.trim()
      : DATA.find(c => c.id === catId)?.title;
    await saveDataToGitHub(newData, `add: ${note} ‚Üí ${catName}`);
    DATA = newData;
    initUI();
    closeModal();
    toast('‚úì Risorsa salvata su GitHub!', 'success');
  } catch (e) {
    toast('Errore salvataggio: ' + e.message, 'error');
    saveLabel.textContent = 'Salva su GitHub';
    modalSave.disabled = false;
  }
});

// ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer;
function toast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = 'show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.className = ''; }, 3200);
}
</script>
</body>
</html>
